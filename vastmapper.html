<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
</head>
<body>
<div id="plane">
</div>
<input id="north" type="button" value="north" style="visibility:hidden;" onclick="loadImg('n')"/>
<input id="south" type="button" value="south" style="visibility:hidden;" onclick="loadImg('s')"/>
<input id="east" type="button" value="east" style="visibility:hidden;" onclick="loadImg('e')"/>
<input id="west" type="button" value="west" style="visibility:hidden;" onclick="loadImg('w')"/>
<script>
//path context for generating paths to the images
var rootContext = "/vastmapper";

/*
init
this array contains a json file
that is made into an array
the array has key values for the 
"vastNumber":"stringDirectionNSEW"
so. {"vast123":"nsw","vast456":"nsew"}
*/
var sourceImagesObj = (function() {
	var sourceImagesObj = null;
	$.ajax({
		'async': false,
        'global': false,
        'url': "images.json",
        'dataType': "json",
        'success': function (data) {
            json = data;
        }
	});
	return json;
})();

//init array for opposite_direction values
var oppositeDirection = {
	"n":"s",
	"s":"n",
	"e":"w",
	"w":"e"
}

//init map stuff
var theMap = {};
var a = Object.keys(theMap);
var neighborhood = {};
//theMap[startImg] = neighborhood;

//make a random starting img
//var imgObjKeys = Object.keys(sourceImagesObj);
var startImgIndex = Math.floor(Math.random() * 247) + 12;
var startImg = vast(startImgIndex);
setImg(startImg);

//console.log("image path " + imgpath);
$('#plane').css({
	height:"300px",
	width:"300px",
	backgroundRepeat: "no-repeat",
	backgroundSize:"cover"
	//backgroundSize:"320px 190px"
});

/*

vast

*/
function vast(number){
	return "vast" + number.toString();
}
/*

setImage

puts a new image on the page
//$('#plane').css("background-image","url(" + imgpath+ ")");
//$('#plane').load(imgpath + ' #plane');

*/
function setImg(img){
	var imgpath = rootContext + '/images/' + img + '.png';
	var image = new Image();
	image.src = imgpath;
	image.onload = function() {
		$('#plane').empty().append(image);
	}
}


/*

nextChecker

takes input vastNum and figues out if it's eligible to add to the neighborhood
vastNum is eligible if:
1) it is not already assigned to the directionTo another vastNumber in themap
2) not the first tile
3) that it can link back to its potential neighbor

*/

function nextChecker(sourceImagesObj, vastNumKey, direction, neighborIndex, opposite_direction, theMap){
	var thisVastsNeighborhood = theMap[vastNumKey];
	var thisVast = vast(neighborIndex);
	for (var vnk in theMap){
		for (var thisVastsNeighborDirection in thisVastsNeighborhood){
			var thisVastsNeighbor = thisVastsNeighborhood[thisVastsNeighborDirection];
			if (thisVastsNeighbor == thisVast){
				return false;
			}
		}
	}
	if (thisVast == startImg){
		return false;
	} else if (sourceImagesObj[thisVast].indexOf(oppositeDirection[direction])<0){
		return false;
	} else {
		return true;
	}
}


/*

setStartObj

creates an initial {"n":"vast123","s":"vast45"} object

*/
function setStartObj(startImg,sourceImagesObj,oppositeDirection,theMap){
	//build a neighborhood for the startImg
	for (var directionIndexFromStartImg in sourceImagesObj[startImg]){
		var direction = sourceImagesObj[startImg][directionIndexFromStartImg];
		var output = false;
		while (output == false){
			var neighborIndex = Math.floor(Math.random() * 247) + 12;
			output = nextChecker(sourceImagesObj, startImg, direction, neighborIndex, oppositeDirection, theMap);
		}
		var thisVast = vast(neighborIndex);
		var neighbor = thisVast;
		neighborhood[direction] = neighbor;
	};
	return neighborhood;
}

//function makeNeighbor(sourceImagesObj,currentVastNum,DIR,oppositeDirection,directionFromCurrentVastNum,theMap){
function makeNeighbor(sourceImagesObj,home,DIR,oppositeDirection,directionFromHome,neighborAtDirectionFromHome,theMap){
	if (DIR == oppositeDirection[directionFromHome]){
		var neighbor = home;
		//alert("eyyy");
	} else {
		var output = false; //init
		count = 0; //init
		while ((output == false) && (count < 100)){
			var neighborNumber = Math.floor(Math.random() * 247) + 12;
			output = nextChecker(sourceImagesObj,neighborAtDirectionFromHome, DIR, neighborNumber, oppositeDirection, theMap);
			count = count + 1;
		}
		if (count < 99){
			count = 0;
			var neighbor = vast(neighborNumber); //convert index to vastNum tile
		} else {
			var neighbor = null;
		}
	}
	return neighbor;
}

//set the startObj here
var neighborhood = setStartObj(startImg,sourceImagesObj,oppositeDirection,theMap);
theMap[startImg] = neighborhood;
//end set startObj
console.log("theMap");
console.log(theMap);
//compute the diff between the empty map and our new themap
//var diff = Object.keys(theMap).filter(function(x) { return a.indexOf(x) < 0});
var diff = Object.keys(theMap)
//console.log(diff);
/*
map generation

starts with the diff of the previous map and the current map
*on first iteration, diff = {startImg{"n":"vast123","s":"vast45"}}
for each item in the diff, e.g. for each new tile/ vastNum added to the map
loops through the directions available in the new tile, these directions havent been assigned yet (see first iteration *)
for each vastNum in the diff
	for each direction available in the vastNum:
		
*/
mapgeneration:
while (diff[0]){
	a = Object.keys(theMap); //assign array to the tiles currently in
	for (vnIndex in diff){ //for vastNumberIndex in list of images that were added
		var home = diff[vnIndex]; //vast number for item in themap we'd like to loop thru. home has a neighborhood already
		for (var directionFromHome in theMap[home]){ //for directions available in current tile
			var neighborAtDirectionFromHome = theMap[home][directionFromHome]; //the vastNum at a direction for the tile in the diff
			console.log(neighborAtDirectionFromHome);
			if (theMap[neighborAtDirectionFromHome]){ continue; } else {
				//directionsOfCurrentVastNum = sourceImagesObj[home]; //the string "nsew" of directions available to tile
				var neighborhood = {}; //init
				var directionsAvailableToNeighbor = sourceImagesObj[neighborAtDirectionFromHome]; //string nsew for directions available in this tile
				for (directionIndex in directionsAvailableToNeighbor){ //loop thru directions available for this tile, directionIndex = "1""2""3""4" for "nsew"
					var DIR = directionsAvailableToNeighbor[directionIndex]; //the direction we're assigning right now, "n" = "nsew"[0]
					neighbor = makeNeighbor(sourceImagesObj,home,DIR,oppositeDirection,directionFromHome,neighborAtDirectionFromHome,theMap);
					if (!neighbor){
						diff[0] == null;
						break mapgeneration;	 
					}
					neighborhood[DIR] = neighbor; //add this direction:tile pair to the dictionary
					
					console.log(neighborhood);
				}	
				theMap[neighborAtDirectionFromHome] = neighborhood; //add the list of neighbor tiles to the map at the key[vastNum]
			}
			//theMap[neighborAtDirectionFromHome][oppositeDirection[directionFromCurrentVastNum]] = currentVastNum; //overwrite whatever is in there with		
		}
	}
	var diff = Object.keys(theMap).filter(function(x) { return a.indexOf(x) < 0});
}
console.log("here");
delete theMap["undefined"];
//console.log(JSON.stringify(theMap));
console.log(theMap);


/*

loads the bottons with every new image
toggles button visibility based on the image's available directions in the map

*/
function loadButtons(){
	var currentImg = $('#plane').children("img").prop('src');
	console.log(currentImg);
	var myRe = /vast\d{1,}/; //make a regex pattern to grip just the vast123 part
	var result = myRe.exec(currentImg); //run that pattern against the url
	var vastImg = result[0];
	var vastImgDirs = sourceImagesObj[vastImg];
	//console.log(vastImgDirs);
	if (vastImgDirs.includes("n") && theMap[vastImg]["n"] != null){
		$('#north').css('visibility','visible');
	}
	if (vastImgDirs.includes("s") && theMap[vastImg]["s"] != null){
		$('#south').css('visibility','visible');
	}
	if (vastImgDirs.includes("e") && theMap[vastImg]["e"] != null){
		$('#east').css('visibility','visible');
	}
	if (vastImgDirs.includes("w") && theMap[vastImg]["w"] != null){
		$('#west').css('visibility','visible');
	}
}


/*

loadImg

loads a new image to #plane on input of a button
new image loaded corresponds to direction pressed by
button, "north" "south" "east" "west"
as delineated by the map

*/
function loadImg(directionTo){
	directionFrom = oppositeDirection[directionTo];
	var currentImg = $('#plane').children("img").prop('src');
	//console.log(currentImg);
	var myRe = /vast\d{1,}/; //make a regex pattern to grip just the vast123 part
	var result = myRe.exec(currentImg); //run that pattern against the url
	var currentImg = result[0];
	if (theMap[currentImg] != null){
		newImg = theMap[currentImg][directionTo];
		setImg(newImg);
		setTimeout(loadButtons(),100)
	}
}
$(document).ready(function(){
	setTimeout(function(){
		loadButtons();
	},1000);
});	
</script>
</body>
</html>