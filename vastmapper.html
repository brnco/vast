<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
</head>
<body>
<div id="plane">
</div>
<script>
var rootContext = "/vastmapper";
//init
var imgarr= (function() {
	var imgarr = null;
	$.ajax({
		'async': false,
        'global': false,
        'url': "images.json",
        'dataType': "json",
        'success': function (data) {
            json = data;
        }
	});
	return json;
})();
//init array for opposite direction values
var opposite = {
	"n":"s",
	"s":"n",
	"e":"w",
	"w":"e"
}
//make a random starting img
var imgIndex = Math.floor(Math.random() * 259);
var imgarrKeys = Object.keys(imgarr);
var startImg = imgarrKeys[imgIndex];
var imgpath = rootContext + '/images/' + startImg + '.png';
//console.log("image path " + imgpath);
$('#plane').css({
	height:"190px",
	width:"320px",
	backgroundRepeat: "no-repeat",
	backgroundSize:"320px 190px"
});
//$('#plane').css("background-image","url(" + imgpath+ ")");
//$('#plane').load(imgpath + ' #plane');
var image = new Image();
image.src = imgpath;
image.onload = function() {
	$('#plane').empty().append(image);
}
//validate indicies of neighbors
//make sure that new tiles to be added are not
//1) not the first tile
//2) that it can link back to its neighbor
function nextChecker(imgarr, imgarrKeys, direction, neighborIndex, opposite, themap){
	if (neighborIndex == imgIndex){
		return false;
	} else if (imgarr[imgarrKeys[neighborIndex]].indexOf(opposite[direction])<0){
		return false;
	} else {
		return true;
	}
}
//init stuff
var themap = {};
var a = Object.keys(themap);
var neighborhood = {};
themap[startImg] = neighborhood;
//build a neighborhood for the startImg
for (v in imgarr[startImg]){
	var direction = imgarr[startImg][v];
	var output = false;
	while (output == false){
		var neighborIndex = Math.floor(Math.random() * 259);
		//console.log(neighborIndex);
		//console.log(imgarrKeys[neighborIndex]);
		//console.log(Object.keys(themap).indexOf(imgarrKeys[neighborIndex]));
		//console.log(themap);
		output = nextChecker(imgarr, imgarrKeys, direction, neighborIndex, opposite, themap);
		//console.log(output);
	}
	var neighbor = imgarrKeys[neighborIndex];
	//console.log(neighbor);
	neighborhood[direction] = neighbor;
};
//assign the neighborhood to themap at index startImg
themap[startImg] = neighborhood;
//compute the diff between the empty map and our new themap
var diff = Object.keys(themap).filter(function(x) { return a.indexOf(x) < 0});
//loop through the new tiles added to the map
//as long as new tiles are added, 
while (typeof diff[0] !== 'undefined' && diff[0] !== null){
	a = Object.keys(themap); //assign array to the tiles currently in
	for (vnIndex in diff){ //for vastNumberIndex in list of images that were added
		currentVastNum = diff[vnIndex]; //vast number for item in themap we'd like to loop thru
		for (direction in themap[currentVastNum]){ //for directions available in current tile
			directionToVastNum = themap[currentVastNum][direction]; //the vastNum at the direction we're coming from
			var neighborhood = {}; //init
			for (dIndex in imgarr[directionToVastNum]){ //loop thru directions available for this tile
				var output = false; //init
				while (output == false){
					//generate index of neighboring tile
					var neighborIndex = Math.floor(Math.random() * 259);
					//check that we can add it
					output = nextChecker(imgarr, imgarrKeys, direction, neighborIndex, opposite, themap);
				}
				var neighbor = imgarrKeys[neighborIndex]; //convert index to vastNum tile
				neighborhood[direction] = neighbor; //add this direction:tile pair to the dictionary
			}
			themap[directionToVastNum] = neighborhood; //add the list of neighbor tiles to the map at the key[vastNum]
		}
		themap[directionToVastNum][opposite[direction]] = currentVastNum; //overwrite whatever is in there with vastNum for direction we're coming from
	}
	var diff = Object.keys(themap).filter(function(x) { return a.indexOf(x) < 0});
}
delete themap["undefined"];
console.log(themap)
</script>
</body>
</html>